name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # ===== ETAPA 1: CI - Proteção de Branch (Com Matrix Strategy - Etapa 5) =====
  ci:
    name: CI - Node ${{ matrix.node-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['18.x', '20.x']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Validação 1: Linting HTML
      - name: Lint HTML (html-validate)
        run: npm run lint

      # Validação 2: Verificar tamanho de arquivos (máx 500KB)
      - name: Check file sizes (max 500KB)
        run: |
          find . -maxdepth 1 -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) | while read file; do
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
            if [ "$size" -gt 500000 ]; then
              echo "::error::$file exceeds 500KB limit"
              exit 1
            fi
          done

      # Validação 3: Varredura de padrões proibidos
      - name: Scan forbidden patterns (TODO, FIXME, senha, password)
        run: |
          if grep -ri -E "TODO|FIXME|senha|password" . \
             --include="*.html" --include="*.css" --include="*.js" \
             --exclude-dir=".git" --exclude-dir="node_modules" 2>/dev/null; then
            echo "::error::Forbidden patterns detected"
            exit 1
          fi

      # Validação 4: Verificar links e imagens
      - name: Validate links and images
        run: |
          grep -oP '(href|src)="\K[^"]+' index.html | while read url; do
            if [[ "$url" =~ ^https?:// ]]; then
              continue
            fi
            if [[ "$url" =~ ^\./ ]]; then
              file_path="${url#./}"
              if [ ! -f "$file_path" ]; then
                echo "::error::Invalid reference: $url"
                exit 1
              fi
            fi
          done

  # ===== ETAPA 2: CD - Deploy para GitHub Pages (após merge em main) =====
  deploy:
    name: Deploy to GitHub Pages
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

  # ===== ETAPA 4: Notificações de Falha =====
  notify:
    name: Notify on failure
    needs: [ci, deploy]
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Notify about failure
        run: |
          echo "❌ Pipeline failed!"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo ""
          echo "Detalhes: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
